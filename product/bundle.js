!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=7)}([function(e,t){e.exports=require("log4js")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(e,t){e.exports={appStatus:{params:[{name:"info",type:"任意",des:"详细信息",necessary:!1}],_links:"/app/status",method:"GET",des:"服务器信息"},listinfo:{params:[],_links:"/app/listinfo",method:"GET",des:"显示api信息"},getLog:{params:[{name:"filename",type:"string",des:"日志文件名字",necessary:!1}],_links:"/app/getLog",method:"GET",des:"获取日志文件，beta"},getWXCode:{params:[{name:"code",type:"string",des:"小程序用户调用wx.login登入获取的code"}],_links:"/wx/onLogin",method:"POST",des:"获取用户openid (https)"},createPreOrder:{params:[{name:"type",type:"number",des:"桶装水的类型"},{name:"num",type:"number",des:"桶装水的数量"},{name:"openid",type:"string",des:"wxOnLogin返回的openID"}],_links:"/wx/createPreOrder",method:"POST",des:"创建预订单 (https)"}}},function(e,t,n){"use strict";var r=(n(8),n(0)),o=r.getLogger("RedisIniter"),s=n(38),i=(n(1),void parseInt(process.env.SessionTimeOut));String.prototype.startWith=function(e){return new RegExp("^"+e).test(this)},String.prototype.endWith=function(e){return new RegExp(e+"$").test(this)},t.boot=function(){var e=n(6).getParams(process.env.RedisUrl);i=new s({port:e.port,host:e.host,family:4,retryStrategy:function(e){return Math.min(50*e,2e3)}});var t=new s(e.port,e.host);i.on("ready",function(){o.info("Ready")}),t.on("ready",function(){t.psubscribe("__keyevent@0__:expired")}),i.on("connect",function(){o.info("connect")}),t.on("pmessage",function(e,t,n){if(n.startWith("serverso")){var r=n.substring(8,n.length);i.lrem("so:server",-1,r)}}),i.on("reconnect",function(){o.warn("reconnect")}),i.on("error",function(e){o.error("error "+e)})},t.SetAndOutRemove=function(e,t,n){return i.set(e,t).then(function(t){return i.expire(e,n)})},t.Get=function(e){return i.get(e)},t.GetAndRemove=function(e){return i.get(e).then(function(t){return i.del(e),t})},t.Del=function(e){return i.del(e).then(function(e){return e>0})},t.client=function(){return i}},function(e,t,n){"use strict";t.getParams=function(e){if(!e)return{};var t=e.split(/:\/\/|:|@|\/|\?/);return{type:t[0],username:t[1],password:t[2],host:t[3],port:t[4],db:t[5],param:t[6]}}},function(e,t,n){"use strict";var r=n(12),o=n(2);n(9).boot(o.resolve("./etc"),o.resolve("../etc"));var s=n(11),i=n(10);if(r.isMaster){console.log(" Fork %s worker(s) from master",1);for(var c=0;c<1;c++)r.fork();r.on("online",function(e){console.log("worker is running on %s pid",e.process.pid)}),r.on("exit",function(e,t,n){console.log("worker with %s is closed",e.process.pid)})}else r.isWorker&&(console.log("worker (%s) is running",r.worker.process.pid),s.boot());r.on("death",function(e){console.log("worker "+e.pid+" died. restart..."),r.fork()});var a=n(3),u=o.join(process.cwd(),"runtime","lock");if(!function(e){try{a.accessSync(e,a.F_OK)}catch(e){return!1}return!0}(u)){var p=a.createWriteStream(u);p.write("lock"),p.end(),i.RegisterTask()}},function(e,t){e.exports=require("lodash")},function(e,t,n){"use strict";var r=n(14),o=n(15);t.boot=function(e,t){r.boot(e,t),o.boot()}},function(e,t,n){"use strict";t.RegisterTask=n(22).RegisterTask},function(e,t,n){"use strict";(function(e){function r(){"test"!==v.get("env")&&v.listen(h,function(){i.info("服务器端口："+h)})}function o(){b.close()}var s=n(0),i=s.getLogger("server"),c=n(35),a=n(36),u=(n(2),n(29));n(30)(u);var p=n(32),f=n(1),d=(f.promisifyAll(n(3)),n(4)),l=n(20),g=n(18),m=n(23),v=c();m.boot(v),v.use(u.urlencoded({extended:!0})),v.use(u.json()),v.use(u.xml({limit:"1MB",xmlParseOptions:{normalize:!0,normalizeTags:!0,explicitArray:!1}})),v.use(p());var y=n(34);v.use(y()),g.boot(v),l.boot(),v.all("*",function(e,t){t.status(404).json({code:404,msg:"没有此Api",_links:d})}),v.use(function(e,t,n,r){return"UnauthorizedError"===e.name?void n.status(401).json({code:401,errCode:401e3,msg:"未许可Api"}):n.headersSent?r(e):(n.status(500),void n.json({code:500,msg:"发生未知错误",_links:d}))});var h=process.env.PORT||3e3,b=a.createServer(v);b.on("error",function(e){i.error(e)}),process.on("uncaughtException",function(e){i.error(e),i.error(e.stack)}),t.app=v,t.boot=r,t.shutdown=o,t.port=h,n.c[n.s]===e?n(7):console.log("Running app as a module")}).call(t,n(27)(e))},function(e,t){e.exports=require("cluster")},function(e,t,n){"use strict";var r=process.env,o=n(1),s=o.promisifyAll(n(3)),i=n(2),c=function(e){try{s.accessSync(e,s.F_OK)}catch(e){return!1}return!0},a=function(e){if(c(e)){var t=s.readFileSync(e,"utf8");if(t){var n=JSON.parse(t);u(r,"",n)}}},u=function e(t,n,r){if(r instanceof Array)t[n]=r;else if(r instanceof Object)for(var o in r)e(t,n+o,r[o]);else t[n]=r};t.ENVSET=function(e,t){e&&(a(i.join(e,"project.json")),a(i.join(e,"db.json")),a(i.join(e,"cluster.json"))),t&&(a(i.join(t,"project.json")),a(i.join(t,"db.json")),a(i.join(t,"cluster.json"))),"production"===process.env.model&&(e&&(a(i.join(e,"production","project.json")),a(i.join(e,"production","db.json")),a(i.join(e,"production","cluster.json"))),t&&(a(i.join(t,"production","project.json")),a(i.join(t,"production","db.json")),a(i.join(t,"production","cluster.json"))))}},function(e,t,n){"use strict";var r=n(13);t.boot=function(e,t){r.ENVSET(e,t)}},function(e,t,n){"use strict";var r=n(16);t.boot=function(){r.set()}},function(e,t,n){"use strict";var r=n(2),o=process.env.name;o=o||"app";var s=r.join(process.cwd(),"logs",o),i={appenders:{STDOUT:{type:"stdout",layout:{type:"ENCODER_PATTERN",separator:","},filter:{level:"error"}},FILE:{type:"dateFile",filename:r.join(s,"common"),pattern:"_yyyy-MM-dd.log",compress:!0,alwaysIncludePattern:!0,layout:{type:"ENCODER_PATTERN",separator:","}},error:{type:"dateFile",filename:r.join(s,"error"),pattern:"_yyyy-MM-dd.log",compress:!0,alwaysIncludePattern:!0,levelFilter:{level:"error"},layout:{type:"ENCODER_PATTERN",separator:","}},ERROR_FILE:{type:"logLevelFilter",appender:"error",level:"error"}},categories:{default:{appenders:["STDOUT","FILE","ERROR_FILE"],level:"info"}}},c=n(39);t.set=function(){var e=n(0);e.addLayout("ENCODER_PATTERN",function(e){return function(e){return c(e.startTime).format("YYYY-MM-DD HH:MM:ss.SSS")+" [main] "+e.level.levelStr+" "+e.categoryName+" - "+e.data}}),e.configure(i)}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("ControllerApp"),s=n(43),i=n(31).exec,c=n(28),a=new Date,u=n(2),p=n(1),f=p.promisifyAll(n(3));t.status=function(e,t){o.info("Status Api Call");var n=e.app;if(e.query.info){var r={};c.parallel([function(e){i("netstat -an | grep :80 | wc -l",function(t,n){r[80]=parseInt(n,10),e()})},function(e){i("netstat -an | grep :"+n.set("port")+" | wc -l",function(t,o){r[n.set("port")]=parseInt(o,10),e()})}],function(e){t.json({status:"up",version:n.get("version"),sha:n.get("git sha"),started_at:a,node:{version:process.version,memory:Math.round(process.memoryUsage().rss/1024/1024)+"M",uptime:process.uptime()},system:{loadavg:s.loadavg(),freeMemory:Math.round(s.freemem()/1024/1024)+"M"},env:"production",hostname:s.hostname(),connections:r,swap:void 0})})}else t.json({status:"up"})};var d=n(4),l={code:0,data:d,model:process.env.model,PVersion:process.env.PVersion,state:process.env.state};t.listinfo=function(e,t){return t.status(200).json(l)};var g=function(e){return f.accessAsync(e,f.F_OK).then(function(e){return!0},function(e){return!1})},m=function(e){return f.readFileAsync(e,"utf8").then(function(e){if(e)return e})},v=function(e,t){var n=u.join(process.cwd(),"runtime","logs",e);g(n).then(function(e){return e?m(n).then(function(e){return e?t.status(200).json({code:0,data:e}):t.status(200).json({code:1})}):t.status(200).json({code:1})})};t.getLog=function(e,t){o.info("getLog api call"),e.query.filename?v(e.query.filename,t):v("latest.log",t)}},function(e,t,n){"use strict";var r=n(17),o=n(19);t.boot=function(e){e.get("/app/status",r.status),e.get("/app/listinfo",r.listinfo),e.get("/app/getLog",r.getLog),e.post("/wx/onLogin",o.wxOnLogin),e.post("/wx/createPreOrder",o.createOrder)}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("ControllerWx");t.wxOnLogin=function(e,t){o.info("wx  user get code Api Call");var n=e.body.code;e.models.paywechat.onlogin(n).then(function(e){return e?t.status(200).json(e):t.status(200).json({code:1,msg:"unknown"})})},t.createOrder=function(e,t){o.info("wx  create order Api Call");var n=e.body.type,r=e.body.num,s=e.body.openid;try{n=parseInt(n)}catch(e){return t.status(200).json({code:1,msg:"type参数错误"})}try{r=parseInt(r)}catch(e){return t.status(200).json({code:1,msg:"num参数错误"})}if(n<0||n>2||r<1||r>200||!s)return t.status(200).json({code:1,msg:"参数错误"});e.models.paywechat.createPreOrder(s,n,r).then(function(e){return e?t.status(200).json(e):t.status(200).json({code:1,msg:"unknown"})})}},function(e,t,n){"use strict";t.boot=function(){n(21).boot(),n(5).boot()}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("MongoseIniter"),s=(n(1),n(40));s.Promise=n(1),t.boot=function(){var e=n(6).getParams(process.env.MongoUrl),t="mongodb://127.0.0.1:27017";e.host&&e.port&&(t="mongodb://"+e.host+":"+e.port);var r={useMongoClient:!0};s.connect(t+"/"+(e.db||"template"),r);var i=s.connection;i.on("error",function(e){o.error(e)}),i.once("open",function(){o.info("MongoDB open:"+e.db)})}},function(e,t,n){"use strict";function r(){var e=0;o.scheduleJob("*/1 * * * * *",function(){if(e+6e4<Date.now()){e=Date.now();var t=encodeURIComponent(process.env.Address),n=encodeURIComponent(process.env.name),r=encodeURIComponent(process.env.desc);c("http://"+process.env.Register+"/register/register?address="+t+"&name="+n+"&desc="+r,"GET",function(o,s,c,a){if(o||!s)return e=0,void i.error("Failure",o);var u="";try{u=JSON.parse(s)}catch(t){e=0,console.log(s)}o||!u||0==!u.code?(e=0,i.error("no register server at:http://"+process.env.Register+"/register/register?address="+t+"&name="+n+"&desc="+r)):i.info("register succeed at time:"+new Date)})}})}var o=n(42),s=n(0),i=s.getLogger("Task"),c=n(37);t.RegisterTask=function(){r()}},function(e,t,n){"use strict";var r=n(24),o={paywechat:r};t.boot=function(e){e.use(function(e,t,n){return e.models=o,n()})}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("ServicePayWeChat"),s=n(41);s.Promise=n(1);var i=(n(44),n(45)),c=n(26).WXUtils,a=n(5),u=process.env.wxappid,p=process.env.wxsecret,f=process.env.wxmchid,d=process.env.wxspBillCreateIp,l=process.env.wxnotify_url,g=process.env.wxkey,m="https://api.weixin.qq.com/sns/jscode2session?appid="+u+"&secret="+p,v={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}};t.onlogin=function(e){return console.log(e),s(m+"&js_code="+e+"&grant_type=authorization_code").then(function(e){return 200==e.status?_.assign(e.json(),{code:0}):{code:1,msg:"return code:"+e.status}}).error(function(e){return{code:1,msg:"unknown",err:e}})};var y=[2e3,1e3,500];t.createPreOrder=function(e,n,r){return t.mockCreatePreOrder(e,n,r)},t.mockCreatePreOrder=function(e,t,n){var r=i.v1(),p=Date.now(),m="dilver-water-"+r,h={_id:m,openid:e,type:t||0===t?t:1,num:n>0&&2e3>n?n:1,date:p,stat:3};return console.log(1),h=JSON.stringify(h),a.SetAndOutRemove("dw:pre:order:"+m,h,36e3).then(function(n){if(!n)return{code:1,msg:"预存储订单失败"};console.log(2);var r=c.createNonceStr(),o=c.createTimeStamp(p),i={appid:u,mch_id:f,nonce_str:r,body:"惠民订水付款",attach:"惠民订水付款",out_trade_no:m,total_fee:y[t],spbill_create_ip:d,notify_url:l,trade_type:"JSAPI",openid:e};console.log(3);var a=c.createFormData(i,g);return s("https://api.mch.weixin.qq.com/pay/unifiedorder",_.assign(v,{body:a})).then(function(e){return 200===e.status&&e.text()}).then(function(e){if(console.log(4),e){var t=c.getXMLNodeValue("prepay_id",e);t=c.getPrepayID(t),console.log(5);var n=c.getPreSign({appId:u,nonceStr:r,package:"prepay_id=wx201411101639507cbf6ffd8b0779950874",signType:"MD5",timeStamp:o},g);return console.log(6),{code:0,appId:u,timeStamp:o,nonceStr:r,signType:"MD5",package:"wx201411101639507cbf6ffd8b0779950874",paySign:n}}return{code:1,msg:"创建订单失败-2",err:res.status}}).error(function(e){return{code:1,msg:"fetch error",err:e}})}).error(function(e){return o.error("保存订单失败："+e),{code:1,msg:"保存订单失败",err:e}})}},function(e,t,n){"use strict";function r(e){var t=Object.keys(e);t=t.sort();var n={};t.forEach(function(t){n[t.toLowerCase()]=e[t]});var r="";for(var o in n)r+="&"+o+"="+n[o];return r=r.substr(1)}function o(e){var t=Object.keys(e);t=t.sort();var n={};t.forEach(function(t){n[t]=e[t]});var r="";for(var o in n)r+="&"+o+"="+n[o];return r=r.substring(1)}var s=(n(8),n(33));t.createNonceStr=function(){return Math.random().toString(36).substr(2,15)},t.createTimeStamp=function(e){return parseInt(e/1e3)+""},t.getSign=function(e,t){var n=r(e);return n=n+"&key="+t,s.createHash("md5").update(n,"utf8").digest("hex").toUpperCase()},t.getPreSign=function(e,t){var n=o(e);return n=n+"&key="+t,s.createHash("md5").update(n,"utf8").digest("hex")},t.getXMLNodeValue=function(e,t){var n=t.split("<"+e+">");if(n.length>1){var r=n[1].split("</"+e+">");if(r.length>0)return r[0]}return null},t.getPrepayID=function(e){if(e){var t=e.split("[");if(t&&t.length>2){var n=t[2].split("]");if(n&&n.length>0)return n[0]}}return null},t.createFormData=function(e,n){var r="<xml>";return r+="<appid>"+e.appid+"</appid>",r+="<mch_id>"+e.mch_id+"</mch_id>",r+="<nonce_str>"+e.nonce_str+"</nonce_str>",r+="<body>"+e.body+"</body>",r+="<attach>"+e.attach+"</attach>",r+="<out_trade_no>"+e.out_trade_no+"</out_trade_no>",r+="<total_fee>"+e.total_fee+"</total_fee>",r+="<spbill_create_ip>"+e.spbill_create_ip+"</spbill_create_ip>",r+="<notify_url>"+e.notify_url+"</notify_url>",r+="<trade_type>"+e.trade_type+"</trade_type>",r+="<openid>"+e.openid+"</openid>",r+="<sign>"+t.getSign(e,n)+"</sign>",r+="</xml>"}},function(e,t,n){"use strict";t.WXUtils=n(25)},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("body-parser-xml")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("errorhandler")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("httpinvoke")},function(e,t){e.exports=require("ioredis")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("node-schedule")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("uuid")}]);